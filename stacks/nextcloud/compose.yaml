# -------------------------------------------------------------------
# Nextcloud stack (app: php-fpm, web: nginx, db: MariaDB, cache: Redis, cron)
# Portable and environment-agnostic. No host ports here.
# Local overrides live in homelab-runtime/stacks/nextcloud/
# -------------------------------------------------------------------

services:
  db:
    image: mariadb@sha256:4b1e7958f820681b1b93b9cf9ea05a76e0785da12699a1fb1d05e0eb2137e56b
    container_name: nc-db
    restart: unless-stopped
    stop_grace_period: 60s
    deploy:
      resources:
        limits: {cpus: "2.0", memory: "2g"}
        reservations: {cpus: "0.50", memory: "512m"}
    logging:
      driver: json-file
      options: {max-size: "10m", max-file: "5"}
    environment:
      MARIADB_DATABASE: ${NC_DB_NAME}
      MARIADB_USER: ${NC_DB_USER}
      MARIADB_PASSWORD: ${NC_DB_PASS}
      MARIADB_ROOT_PASSWORD: ${NC_DB_ROOT}
    volumes:
      - db:/var/lib/mysql
    healthcheck:
      test: ["CMD-SHELL", "test -S /run/mysqld/mysqld.sock || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 30
      start_period: 30s
    labels:
      com.repo: homelab-stacks
      com.stack: nextcloud
      com.env: lab
      com.logging: "true"

  redis:
    image: redis@sha256:90e7a336d044f1abc9e9dbc05d65566850896d11453bbd1dd0fb7e5059f0e8fb
    container_name: nc-redis
    restart: unless-stopped
    command: ["redis-server", "--appendonly", "yes"]
    deploy:
      resources:
        limits: {cpus: "0.50", memory: "256m"}
        reservations: {cpus: "0.10", memory: "64m"}
    logging:
      driver: json-file
      options: {max-size: "10m", max-file: "3"}
    volumes:
      - redis:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 10
    labels:
      com.repo: homelab-stacks
      com.stack: nextcloud
      com.env: lab
      com.logging: "true"

  app:
    image: nextcloud@sha256:2a2078e24cb19b22bf0052aae7a5cce74b51ebe41676f72f5783b5953619c4a1
    container_name: nc-app
    restart: unless-stopped
    stop_grace_period: 30s
    deploy:
      resources:
        limits: {cpus: "2.0", memory: "2g"}
        reservations: {cpus: "0.50", memory: "512m"}
    logging:
      driver: json-file
      options: {max-size: "10m", max-file: "3"}
    environment:
      MYSQL_HOST: db
      MYSQL_DATABASE: ${NC_DB_NAME}
      MYSQL_USER: ${NC_DB_USER}
      MYSQL_PASSWORD: ${NC_DB_PASS}
      NEXTCLOUD_TRUSTED_DOMAINS: ${NC_DOMAIN}
      NEXTCLOUD_ADMIN_USER: ${NC_ADMIN_USER}
      NEXTCLOUD_ADMIN_PASSWORD: ${NC_ADMIN_PASS}
      PHP_MEMORY_LIMIT: ${PHP_MEMORY_LIMIT}
      PHP_UPLOAD_LIMIT: ${PHP_UPLOAD_LIMIT}
    depends_on:
      db: {condition: service_healthy}
      redis: {condition: service_healthy}
    volumes:
      - nextcloud:/var/www/html
      # php.ini comes from runtime override
    healthcheck:
      test: ["CMD-SHELL", "php -r 'echo 0;'"]
      interval: 30s
      timeout: 5s
      retries: 10
    labels:
      com.repo: homelab-stacks
      com.stack: nextcloud
      com.env: lab
      com.logging: "true"

  web:
    image: nginx@sha256:6784fb0834aa7dbbe12e3d7471e69c290df3e6ba810dc38b34ae33d3c1c05f7d
    container_name: nc-web
    restart: unless-stopped
    deploy:
      resources:
        limits: {cpus: "1.0", memory: "512m"}
        reservations: {cpus: "0.10", memory: "64m"}
    logging:
      driver: json-file
      options: {max-size: "10m", max-file: "3"}
    depends_on:
      app: {condition: service_started}
    volumes:
      - nextcloud:/var/www/html:ro
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
    expose:
      - "8080"
    networks:
      - default
      - proxy
    healthcheck:
      test: ["CMD-SHELL", "test -f /var/www/html/index.php || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 10
    labels:
      com.repo: homelab-stacks
      com.stack: nextcloud
      com.env: lab
      com.logging: "true"

  cron:
    image: nextcloud@sha256:2a2078e24cb19b22bf0052aae7a5cce74b51ebe41676f72f5783b5953619c4a1
    container_name: nc-cron
    user: "33:33"
    restart: unless-stopped
    stop_grace_period: 20s
    deploy:
      resources:
        limits: {cpus: "0.50", memory: "512m"}
        reservations: {cpus: "0.10", memory: "128m"}
    logging:
      driver: json-file
      options: {max-size: "10m", max-file: "3"}
    entrypoint: ["/bin/sh", "-c"]
    command: ["trap exit TERM; while :; do php -f /var/www/html/cron.php; sleep 300; done"]
    depends_on:
      app: {condition: service_started}
    volumes:
      - nextcloud:/var/www/html
      # php.ini comes from runtime override
    labels:
      com.repo: homelab-stacks
      com.stack: nextcloud
      com.env: lab
      com.logging: "true"

networks:
  proxy:
    external: true

volumes:
  db: {}
  redis: {}
  nextcloud: {}
