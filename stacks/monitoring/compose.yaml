# homelab-stacks/stacks/monitoring/compose.yaml
# -------------------------------------------------------------------
# Base monitoring stack: Prometheus, Alertmanager, Loki, Promtail,
# Grafana, Blackbox Exporter, Node Exporter, cAdvisor.
# Portable: no host ports here â€” publish only Grafana via your
# reverse proxy / tunnel. Images pinned by digest. External networks:
# `monitoring` (internal) and `proxy` (reverse proxy).
# Runtime overrides live in homelab-runtime/stacks/monitoring/.
# -------------------------------------------------------------------

services:
  prometheus:
    image: prom/prometheus@sha256:ff7e389acbe064a4823212a500393d40a28a8f362e4b05cbf6742a9a3ef736b2
    container_name: mon-prometheus
    command:
      - --config.file=/etc/prometheus/prometheus.yml
      - --storage.tsdb.path=/prometheus
      - --web.enable-lifecycle
    expose:
      - "9090"
    volumes:
      - mon-prom-data:/prometheus
      - /opt/homelab-stacks/stacks/monitoring/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:9090/-/ready"]
      interval: 10s
      timeout: 3s
      retries: 6
    networks:
      - mon-net
      - proxy
    restart: unless-stopped
    labels:
      com.repo: homelab-stacks
      com.stack: monitoring
      com.env: lab
      com.logging: "true"

  alertmanager:
    image: prom/alertmanager@sha256:27c475db5fb156cab31d5c18a4251ac7ed567746a2483ff264516437a39b15ba
    container_name: mon-alertmanager
    command: ["--config.file=/etc/alertmanager/alertmanager.yml"]
    expose:
      - "9093"
    volumes:
      - /opt/homelab-stacks/stacks/monitoring/alertmanager/alertmanager.yml:/etc/alertmanager/alertmanager.yml:ro
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:9093/-/ready"]
      interval: 15s
      timeout: 3s
      retries: 6
    networks:
      - mon-net
    restart: unless-stopped
    labels:
      com.repo: homelab-stacks
      com.stack: monitoring
      com.env: lab
      com.logging: "true"

  blackbox:
    image: prom/blackbox-exporter@sha256:a50c4c0eda297baa1678cd4dc4712a67fdea713b832d43ce7fcc5f9bea05094d
    container_name: mon-blackbox
    expose:
      - "9115"
    cap_add:
      - NET_RAW
    volumes:
      - /opt/homelab-stacks/stacks/monitoring/blackbox/blackbox.yml:/etc/blackbox_exporter/config.yml:ro
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:9115/"]
      interval: 30s
      timeout: 3s
      retries: 6
    networks:
      - mon-net
    restart: unless-stopped
    labels:
      com.repo: homelab-stacks
      com.stack: monitoring
      com.env: lab
      com.logging: "true"

  loki:
    image: grafana/loki@sha256:0eaee7bf39cc83aaef46914fb58f287d4f4c4be6ec96b86c2ed55719a75e49c8
    container_name: mon-loki
    command: ["-config.file=/etc/loki/local-config.yaml"]
    expose:
      - "3100"
    volumes:
      - mon-loki-data:/loki
      - /opt/homelab-stacks/stacks/monitoring/loki/config.yaml:/etc/loki/local-config.yaml:ro
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:3100/ready >/dev/null"]
      interval: 15s
      timeout: 3s
      retries: 6
    networks:
      - mon-net
    restart: unless-stopped
    labels:
      com.repo: homelab-stacks
      com.stack: monitoring
      com.env: lab
      com.logging: "true"

  promtail:
    image: grafana/promtail@sha256:086e4e85d2eb383fb04ea83c0f5074da81df56e415062ca888dba426abd8dfa5
    container_name: mon-promtail
    command: ["-config.file=/etc/promtail/config.yml"]
    expose:
      - "9080"
    volumes:
      - /opt/homelab-stacks/stacks/monitoring/promtail/config.yaml:/etc/promtail/config.yml:ro
      - mon-promtail-positions:/positions
    networks:
      - mon-net
    restart: unless-stopped
    labels:
      com.repo: homelab-stacks
      com.stack: monitoring
      com.env: lab
      com.logging: "true"

  node-exporter:
    image: prom/node-exporter@sha256:d00a542e409ee618a4edc67da14dd48c5da66726bbd5537ab2af9c1dfc442c8a
    container_name: mon-node-exporter
    command: ["--path.rootfs=/host"]
    expose:
      - "9100"
    networks:
      - mon-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:9100/metrics >/dev/null || exit 1"]
      interval: 30s
      timeout: 3s
      retries: 6
      start_period: 10s
    labels:
      com.repo: homelab-stacks
      com.stack: monitoring
      com.env: lab
      com.logging: "true"

  cadvisor:
    image: gcr.io/cadvisor/cadvisor@sha256:3cde6faf0791ebf7b41d6f8ae7145466fed712ea6f252c935294d2608b1af388
    container_name: mon-cadvisor
    command:
      - --docker_only
      - --housekeeping_interval=30s
      # Optional noise reduction:
      - --disable_metrics=hugetlb,referenced_memory,resctrl,sched,tcp,udp,advtcp
    expose:
      - "8080"
    # NOTE: host mounts for /proc, /sys and Docker roots are intentionally
    # omitted here to keep the base compose portable. Bind them in your
    # runtime override (rootless example):
    #   - ${XDG_RUNTIME_DIR}/docker.sock:/var/run/docker.sock:ro
    #   - ${HOME}/.local/share/docker:/var/lib/docker:ro
    #   - /proc:/host/proc:ro
    #   - /sys:/host/sys:ro
    #   - /:/rootfs:ro
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:8080/healthz"]
      interval: 30s
      timeout: 5s
      retries: 5
    networks:
      - mon-net
    restart: unless-stopped
    labels:
      com.repo: homelab-stacks
      com.stack: monitoring
      com.env: lab
      com.logging: "true"

  grafana:
    image: grafana/grafana@sha256:74144189b38447facf737dfd0f3906e42e0776212bf575dc3334c3609183adf7
    container_name: mon-grafana
    expose:
      - "3000"
    environment:
      GF_SECURITY_ADMIN_USER: ${GRAFANA_ADMIN_USER:-admin}
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_ADMIN_PASSWORD:-admin}
      TZ: ${TZ:-Europe/Madrid}
    volumes:
      - mon-grafana-data:/var/lib/grafana
      - /opt/homelab-stacks/stacks/monitoring/grafana/provisioning.mon/datasources:/etc/grafana/provisioning/datasources:ro
      - /opt/homelab-stacks/stacks/monitoring/grafana/provisioning.mon/dashboards:/etc/grafana/provisioning/dashboards:ro
      - ${STACKS_DIR:-/opt/homelab-stacks}/stacks/monitoring/grafana/dashboards/exported/mon:/etc/grafana/provisioning/dashboards/exported-mon:ro
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:3000/api/health"]
      interval: 10s
      timeout: 3s
      retries: 12
    networks:
      - mon-net
      - proxy
    restart: unless-stopped
    labels:
      com.repo: homelab-stacks
      com.stack: monitoring
      com.env: lab
      com.logging: "true"

volumes:
  mon-prom-data:
    name: mon-prom-data
  mon-grafana-data:
    name: mon-grafana-data
  mon-loki-data:
    name: mon-loki-data
  mon-promtail-positions:
    name: mon-promtail-positions

networks:
  mon-net:
    external: true
  proxy:
    external: true
