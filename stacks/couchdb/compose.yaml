# -------------------------------------------------------------------
# Base definition of the CouchDB stack (v3.x)
# Self-hosted document database (Obsidian LiveSync ready)
# Portable and environment-agnostic. No ports exposed by default.
# Local overrides live in homelab-runtime/stacks/couchdb/
# -------------------------------------------------------------------

services:
  couchdb:
    image: couchdb@sha256:d3fb6f79033173171d6f73f8c7f9d8e2c885a83fc88125991dba1f8e6a936577
    container_name: couchdb
    expose:
      - "5984"
    environment:
      COUCHDB_USER: ${COUCHDB_USER}
      COUCHDB_PASSWORD: ${COUCHDB_PASSWORD}
    networks:
      - proxy
    restart: unless-stopped
    stop_grace_period: 60s
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://127.0.0.1:5984/_up"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 15s
    labels:
      com.repo: homelab-stacks
      com.stack: couchdb
      com.env: lab


  couchdb-exporter:
    image: gesellix/couchdb-prometheus-exporter@sha256:a4e3425024a608fb92c9252919f71f5c0bff7cdb83d9f4e7ede59e0b9bcf8a1b
    container_name: couchdb-exporter
    restart: unless-stopped
    depends_on:
      couchdb:
        condition: service_healthy
    command:
      - --couchdb.uri=http://couchdb:5984
    environment:
      COUCHDB_USERNAME: ${COUCHDB_USER}
      COUCHDB_PASSWORD: ${COUCHDB_PASSWORD}
    networks:
      - proxy
      - mon-net
    labels:
      com.repo: homelab-stacks
      com.stack: couchdb
      com.env: lab

networks:
  proxy:
    external: true
  mon-net:
    external: true
