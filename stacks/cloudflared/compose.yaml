# homelab-stacks/stacks/cloudflared/compose.yaml
# -------------------------------------------------------------------
# Base definition of the Cloudflare Tunnel stack
# Provides secure outbound access to internal Docker services.
# This compose file is portable and environment-agnostic.
# Local overrides live in homelab-runtime/stacks/cloudflared/
# -------------------------------------------------------------------

services:
  cloudflared:
    image: cloudflare/cloudflared@sha256:4604b477520dc8322af5427da68b44f0bf814938e9d2e4814f2249ee4b03ffdf
    user: "${CLOUDFLARED_UID:-65532}:${CLOUDFLARED_GID:-65532}"
    restart: unless-stopped
    command: >
      tunnel --config /etc/cloudflared/config.yml --metrics 0.0.0.0:8081 run
    volumes:
      - ./cloudflared/config.yml:/etc/cloudflared/config.yml:ro
      # Credential JSON is mounted via runtime override (CLOUDFLARED_CRED_FILE).
    networks:
      - proxy
      - mon-net
    labels:
      com.repo: homelab-stacks
      com.stack: cloudflared
      com.env: home
      service: cloudflared
      com.logging: "true"

networks:
  proxy:
    external: true
  mon-net:
    external: true
