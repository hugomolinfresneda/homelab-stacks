#!/usr/bin/env bash
# Nextcloud stack helper
# - Consistent docker compose entrypoints for base + runtime override
# - Optional profiles (e.g. "monitoring") for exporters or extra services
# - Defensive down: includes monitoring profile if exporters are present
set -euo pipefail

# ---------- Defaults (export to override) ----------
WORKSPACE=${WORKSPACE:-$HOME/Proyectos/Curro}
STACKS_REPO=${STACKS_REPO:-"$WORKSPACE/homelab-stacks"}
RUNTIME_DIR=${RUNTIME_DIR:-"$WORKSPACE/homelab-runtime/stacks/nextcloud"}
ENV_FILE="$RUNTIME_DIR/.env"
QUIET=${QUIET:-0}                 # 1 = reduced output

# Optional, space-separated: e.g. PROFILES="monitoring debug"
PROFILES=${PROFILES:-}

# Curl image for lightweight HTTP checks
CURL_IMG=${CURL_IMG:-curlimages/curl:8.10.1}

BASE_FILE="$STACKS_REPO/stacks/nextcloud/compose.yaml"
OVRD_FILE="$RUNTIME_DIR/compose.override.yml"

# ---------- Compose command builders ----------
# Build "--profile ..." flags for the current PROFILES set
build_profile_flags() {
  local flags=""
  if [[ -n "${PROFILES}" ]]; then
    for p in ${PROFILES}; do
      [[ -n "$p" ]] && flags+=" --profile $p"
    done
  fi
  printf '%s' "$flags"
}

# For 'down': include current profiles and, if exporters are detected,
# ensure "--profile monitoring" is present even if not specified.
build_profile_flags_for_down() {
  local flags
  flags="$(build_profile_flags)"
  if exporters_present && ! has_profile "monitoring"; then
    flags+=" --profile monitoring"
  fi
  printf '%s' "$flags"
}

PROF_STR="$(build_profile_flags)"

BASE="docker compose --env-file \"$ENV_FILE\"$PROF_STR -f \"$BASE_FILE\""
OVRD="docker compose --env-file \"$ENV_FILE\"$PROF_STR -f \"$BASE_FILE\" -f \"$OVRD_FILE\""

# ---------- Helpers ----------
log()  { echo "▶ $*"; }
run()  { if [ "$QUIET" = "1" ]; then eval "$*" >/dev/null 2>&1; else eval "$*"; fi; }
occ()  { docker exec -w /var/www/html -u www-data nc-app php occ "$@"; }

has_profile() {
  # usage: has_profile <name>
  [[ " ${PROFILES:-} " =~ [[:space:]]$1[[:space:]] ]]
}

exporters_present() {
  # Detect known exporter container names from this stack
  docker ps -a --format '{{.Names}}' | grep -Eq '^nc-(mysqld|redis)-exporter$'
}

wait_for_code() {
  log "Waiting for Nextcloud application code to be available..."
  until docker exec nc-app test -f /var/www/html/occ; do sleep 1; done
  until docker exec nc-app test -f /var/www/html/lib/versioncheck.php; do sleep 1; done
}

ensure_config_dir() {
  docker exec -u root nc-app sh -lc 'install -d -o 33 -g 33 -m 0750 /var/www/html/config'
}

seed_snippets() {
  ensure_config_dir
  for f in 10-redis.config.php 20-proxy.config.php; do
    if ! docker exec -u root nc-app test -f "/var/www/html/config/$f"; then
      docker cp "$STACKS_REPO/stacks/nextcloud/config/$f.example" "nc-app:/var/www/html/config/$f"
      docker exec -u root nc-app chown 33:33 "/var/www/html/config/$f" || true
    fi
  done
}

is_installed() {
  docker exec -w /var/www/html -u www-data nc-app sh -lc \
    'php occ status 2>/dev/null | grep -q "installed: true"' >/dev/null 2>&1
}

wait_until_installed() {
  for _ in $(seq 1 120); do
    if is_installed; then return 0; fi
    sleep 1
  done
  return 1
}

usage() {
  cat >&2 <<'USAGE'
Usage: nc {up|install|post|status|logs|reset-db|down}

Environment:
  PROFILES="monitoring"   Enable profiled services (e.g., exporters)
  QUIET=1                 Reduce output noise
  CURL_IMG=...            Container image for HTTP checks (default: curlimages/curl:8.10.1)
USAGE
}

# ---------- Commands ----------
case "${1:-}" in
  up)
    mkdir -p "$RUNTIME_DIR"
    log "Starting database and Redis"
    run "$BASE up -d db redis"

    log "Starting application, web, and cron"
    run "$OVRD up -d app web cron"

    if has_profile monitoring; then
      log "Starting monitoring exporters"
      run "$OVRD up -d mysqld-exporter redis-exporter"
    fi
    ;;

  install)
    wait_for_code
    ensure_config_dir
    if is_installed; then
      log "[install] Already installed — skipping"
    else
      log "[install] Waiting for application to complete self-installation..."
      if ! wait_until_installed; then
        echo "ERROR: Nextcloud not installed within the expected time. Check 'docker logs nc-app'." >&2
        exit 1
      fi
    fi
    seed_snippets
    ;;

  post)
    wait_for_code
    if ! is_installed; then
      log "[post] Skipping — application not installed yet"
      exit 0
    fi
    seed_snippets
    occ background:cron || true
    docker exec -w /var/www/html -u www-data nc-app sh -lc '
      if [ -n "${NEXTCLOUD_TRUSTED_DOMAINS:-${NC_DOMAIN:-}}" ]; then
        php occ config:system:set trusted_domains 1 --value "${NEXTCLOUD_TRUSTED_DOMAINS:-${NC_DOMAIN:-}}"
      fi
      php occ config:system:set trusted_domains 2 --value "nc-web"
      php occ config:system:set trusted_domains 3 --value "localhost"
    ' || true
    if [ -n "${NC_DOMAIN:-}" ]; then
      occ config:system:set overwrite.cli.url --value="https://${NC_DOMAIN}" || true
    fi
    occ db:add-missing-indices || true
    occ maintenance:repair || true
    occ status || true
    ;;

  status)
    if is_installed; then
      occ status || true
    else
      echo "  - installed: false"
    fi
    docker run --rm --network nextcloud_default "$CURL_IMG" -sSI http://nc-web:8080/status.php | head -n1 || true
    if [ -n "${NC_DOMAIN:-}" ]; then
      docker run --rm --network nextcloud_default "$CURL_IMG" -sSI -H "Host: ${NC_DOMAIN}" http://nc-web:8080/status.php | head -n1 || true
    fi
    ;;

  logs)
    run "$OVRD logs -f app"
    ;;

  reset-db)
    log "Resetting ONLY the database volume (application data remains)"
    docker stop nc-db >/dev/null 2>&1 || true
    docker rm   nc-db >/dev/null 2>&1 || true
    docker volume rm nextcloud_db >/dev/null 2>&1 || true
    run "$BASE up -d db redis"
    ;;

  down)
    # Build a compose command that includes profiles for exporters if needed.
    DOWN_PROF_STR="$(build_profile_flags_for_down)"
    CMD_DOWN="docker compose --env-file \"$ENV_FILE\"$DOWN_PROF_STR -f \"$BASE_FILE\" -f \"$OVRD_FILE\""

    if [[ "$DOWN_PROF_STR" == *"--profile monitoring"* ]]; then
      log "Stopping stack (including monitoring profile)"
    else
      log "Stopping stack"
    fi

    # Primary attempt: stop everything and remove orphans.
    run "$CMD_DOWN down --remove-orphans"

    # Safety net: ensure exporters and default network are fully removed.
    docker rm -f nc-mysqld-exporter nc-redis-exporter >/dev/null 2>&1 || true
    docker network rm nextcloud_default >/dev/null 2>&1 || true
    ;;

  *)
    usage; exit 1 ;;
esac
