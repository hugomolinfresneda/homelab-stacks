# homelab-stacks/stacks/monitoring/compose.yaml
# -------------------------------------------------------------------
# Base monitoring stack: Prometheus, Alertmanager, Loki, Promtail,
# Grafana, Blackbox Exporter, Node Exporter, cAdvisor.
# Portable: no host ports here â€” publish only Grafana via your
# reverse proxy / tunnel. Images pinned by digest. External networks:
# `mon-net` (internal) and `proxy` (reverse proxy).
# Runtime overrides live in homelab-runtime/stacks/monitoring/.
# -------------------------------------------------------------------

services:
  prometheus:
    image: prom/prometheus@sha256:ff7e389acbe064a4823212a500393d40a28a8f362e4b05cbf6742a9a3ef736b2
    container_name: mon-prometheus
    command:
      - --config.file=/etc/prometheus/prometheus.yml
      - --storage.tsdb.path=/prometheus
      - --web.enable-lifecycle
      - --config.expand-env
    expose:
      - "9090"
    volumes:
      - mon-prom-data:/prometheus
      - ${STACKS_DIR:?}/stacks/monitoring/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ${STACKS_DIR:?}/stacks/monitoring/prometheus/rules/:/etc/prometheus/rules/:ro
    environment:
      PROM_ALERTMANAGER_TARGETS: ${PROM_ALERTMANAGER_TARGETS:?}
      PROM_SELF_TARGETS: ${PROM_SELF_TARGETS:?}
      PROM_BLACKBOX_TARGETS: ${PROM_BLACKBOX_TARGETS:?}
      PROM_NODE_EXPORTER_TARGETS: ${PROM_NODE_EXPORTER_TARGETS:?}
      PROM_LOKI_TARGETS: ${PROM_LOKI_TARGETS:?}
      PROM_PROMTAIL_TARGETS: ${PROM_PROMTAIL_TARGETS:?}
      PROM_UPTIME_KUMA_TARGETS: ${PROM_UPTIME_KUMA_TARGETS:?}
      PROM_CADVISOR_TARGETS: ${PROM_CADVISOR_TARGETS:?}
      PROM_NEXTCLOUD_EXPORTER_TARGETS: ${PROM_NEXTCLOUD_EXPORTER_TARGETS:?}
      PROM_ADGUARD_EXPORTER_TARGETS: ${PROM_ADGUARD_EXPORTER_TARGETS:?}
      PROM_ADGUARD_DNS_TARGETS: ${PROM_ADGUARD_DNS_TARGETS:?}
      PROM_CLOUDFLARED_TARGETS: ${PROM_CLOUDFLARED_TARGETS:?}
      PROM_COUCHDB_EXPORTER_TARGETS: ${PROM_COUCHDB_EXPORTER_TARGETS:?}
      ROOT_MOUNTPOINT: ${ROOT_MOUNTPOINT:?}
      ROOT_FSTYPE: ${ROOT_FSTYPE:?}
      BACKUP_MOUNTPOINT: ${BACKUP_MOUNTPOINT:?}
      BACKUP_FSTYPE: ${BACKUP_FSTYPE:?}
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:9090/-/ready"]
      interval: 10s
      timeout: 3s
      retries: 6
    networks:
      - mon-net
      - proxy
    restart: unless-stopped
    labels:
      com.repo: homelab-stacks
      com.stack: monitoring
      com.env: lab
      com.logging: "true"

  alertmanager:
    image: prom/alertmanager@sha256:27c475db5fb156cab31d5c18a4251ac7ed567746a2483ff264516437a39b15ba
    container_name: mon-alertmanager
    command:
      - "--config.file=/etc/alertmanager/alertmanager.yml"
      # Public URL used by templates (.ExternalURL) to build Alert/Silence links.
      # Runtime-only: set --web.external-url in runtime (compose.override.yml).
    expose:
      - "9093"
    volumes:
      - ${STACKS_DIR:?}/stacks/monitoring/alertmanager/alertmanager.yml:/etc/alertmanager/alertmanager.yml:ro
      - ${STACKS_DIR:?}/stacks/monitoring/alertmanager/templates:/etc/alertmanager/templates:ro
      - mon-alertmanager-data:/alertmanager
      # Runtime-only:
      # - Mount Telegram bot token as a file so Alertmanager can read it via bot_token_file.
      # - Example:
      #   - /srv/secrets/alertmanager/TG_BOT_TOKEN:/run/secrets/telegram_bot_token:ro
      #
      # NOTE: Alertmanager supports bot_token_file but not chat_id_file.
      # chat_id must be configured explicitly in alertmanager.yml (placeholder in public repo).
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:9093/-/ready"]
      interval: 15s
      timeout: 3s
      retries: 6
    networks:
      - mon-net
    restart: unless-stopped
    environment:
      TZ: Europe/Madrid
    labels:
      com.repo: homelab-stacks
      com.stack: monitoring
      com.env: lab
      com.logging: "true"

  blackbox:
    image: prom/blackbox-exporter@sha256:a50c4c0eda297baa1678cd4dc4712a67fdea713b832d43ce7fcc5f9bea05094d
    container_name: mon-blackbox
    expose:
      - "9115"
    cap_add:
      - NET_RAW
    volumes:
      - ${STACKS_DIR:?}/stacks/monitoring/blackbox/blackbox.yml:/etc/blackbox_exporter/config.yml:ro
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:9115/"]
      interval: 30s
      timeout: 3s
      retries: 6
    networks:
      - mon-net
    restart: unless-stopped
    labels:
      com.repo: homelab-stacks
      com.stack: monitoring
      com.env: lab
      com.logging: "true"

  loki:
    image: grafana/loki@sha256:0eaee7bf39cc83aaef46914fb58f287d4f4c4be6ec96b86c2ed55719a75e49c8
    container_name: mon-loki
    command: ["-config.file=/etc/loki/local-config.yaml"]
    expose:
      - "3100"
    volumes:
      - mon-loki-data:/loki
      - ${STACKS_DIR:?}/stacks/monitoring/loki/config.yaml:/etc/loki/local-config.yaml:ro
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:3100/ready >/dev/null"]
      interval: 15s
      timeout: 3s
      retries: 6
    networks:
      - mon-net
    restart: unless-stopped
    labels:
      com.repo: homelab-stacks
      com.stack: monitoring
      com.env: lab
      com.logging: "true"

  promtail:
    image: grafana/promtail@sha256:086e4e85d2eb383fb04ea83c0f5074da81df56e415062ca888dba426abd8dfa5
    container_name: mon-promtail
    command: ["-config.file=/etc/promtail/config.yml"]
    expose:
      - "9080"
    volumes:
      - ${STACKS_DIR:?}/stacks/monitoring/promtail/config.yaml:/etc/promtail/config.yml:ro
      - mon-promtail-positions:/positions
      # Runtime-only:
      # - Docker socket + containers log path (rootful or rootless)
      # - Example:
      #   - ${DOCKER_SOCK}:/var/run/docker.sock:ro${SELINUX_SUFFIX}
      #   - ${DOCKER_CONTAINERS_DIR}:/var/lib/docker/containers:ro${SELINUX_SUFFIX}
    networks:
      - mon-net
    restart: unless-stopped
    labels:
      com.repo: homelab-stacks
      com.stack: monitoring
      com.env: lab
      com.logging: "true"

  node-exporter:
    image: prom/node-exporter@sha256:d00a542e409ee618a4edc67da14dd48c5da66726bbd5537ab2af9c1dfc442c8a
    container_name: mon-node-exporter
    command:
      - '--path.rootfs=/host'
      - '--collector.textfile'
      - '--collector.textfile.directory=/textfile-collector'
    # Runtime-only:
    # - /:/host:ro,rslave
    # - ${NODE_EXPORTER_TEXTFILE_DIR}:/textfile-collector:ro${SELINUX_SUFFIX}
    volumes: []
    expose:
      - "9100"
    networks:
      - mon-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:9100/metrics >/dev/null || exit 1"]
      interval: 30s
      timeout: 3s
      retries: 6
      start_period: 10s
    labels:
      com.repo: homelab-stacks
      com.stack: monitoring
      com.env: lab
      com.logging: "true"

  cadvisor:
    image: gcr.io/cadvisor/cadvisor@sha256:505e2c61e74e5d5eae522d01e2e971e91b793bc405270315a64da806ba033640
    container_name: mon-cadvisor
    expose:
      - "8080"
    # Runtime-only:
    # - /:/rootfs:ro
    # - /var/run:/var/run:ro
    # - /sys:/sys:ro
    # - /var/lib/docker:/var/lib/docker:ro
    volumes: []
    command:
      - --docker_only
      - --housekeeping_interval=30s
      # Optional noise reduction:
      - --disable_metrics=hugetlb,referenced_memory,resctrl,sched,tcp,udp,advtcp
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:8080/healthz"]
      interval: 30s
      timeout: 5s
      retries: 5
    networks:
      - mon-net
    restart: unless-stopped
    labels:
      com.repo: homelab-stacks
      com.stack: monitoring
      com.env: lab
      com.logging: "true"

  grafana:
    image: grafana/grafana@sha256:74144189b38447facf737dfd0f3906e42e0776212bf575dc3334c3609183adf7
    container_name: mon-grafana
    expose:
      - "3000"
    environment:
      GF_SECURITY_ADMIN_USER: ${GRAFANA_ADMIN_USER:-admin}
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_ADMIN_PASSWORD:-admin}
      TZ: ${TZ:-Europe/Madrid}
    volumes:
      - mon-grafana-data:/var/lib/grafana
      - ${STACKS_DIR:?}/stacks/monitoring/grafana/provisioning.mon/datasources:/etc/grafana/provisioning/datasources:ro
      - ${STACKS_DIR:?}/stacks/monitoring/grafana/provisioning.mon/dashboards:/etc/grafana/provisioning/dashboards:ro
      - ${STACKS_DIR:?}/stacks/monitoring/grafana/dashboards/exported/mon:/etc/grafana/provisioning/dashboards/exported-mon:ro
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:3000/api/health"]
      interval: 10s
      timeout: 3s
      retries: 12
    networks:
      - mon-net
      - proxy
    restart: unless-stopped
    labels:
      com.repo: homelab-stacks
      com.stack: monitoring
      com.env: lab
      com.logging: "true"

volumes:
  mon-prom-data:
    name: mon-prom-data
  mon-grafana-data:
    name: mon-grafana-data
  mon-loki-data:
    name: mon-loki-data
  mon-promtail-positions:
    name: mon-promtail-positions
  mon-alertmanager-data:
    name: mon-alertmanager-data

networks:
  mon-net:
    external: true
  proxy:
    external: true
