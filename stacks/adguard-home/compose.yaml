# homelab-stacks/stacks/adguard-home/compose.yaml
# -------------------------------------------------------------------
# Base definition of the AdGuard Home stack (DNS filtering for LAN)
# Portable and environment-agnostic. No host ports or volumes here.
# Local overrides live in homelab-runtime/stacks/adguard-home/
# -------------------------------------------------------------------

x-anchors:
  labels-stack: &labels_stack
    com.stack: adguard-home
  restart-policy: &restart_policy unless-stopped
  networks:
    proxy-mon: &net_proxy_mon
      - proxy
      - mon-net

services:
  adguard-home:
    image: adguard/adguardhome@sha256:09a24f05e110e53e213a340b22e5d3c8cdab12ff9be6775388c71b140255c54c
    expose:
      - "3000"   # Web UI (wizard/admin). Keep 3000; runtime will map host:3000
    environment:
      TZ: ${TZ:-Europe/Madrid}
    networks: *net_proxy_mon
    restart: *restart_policy
    labels:
      <<: *labels_stack
      com.repo: homelab-stacks
      com.env: lab
      com.logging: "true"

  adguard-exporter:
    image: ebrianne/adguard-exporter@sha256:03b2fda733121eb7de3310362bc1b5bc0a7b2d93aca6946a6b5c31e97f4cd85b
    environment:
      adguard_protocol: ${ADGUARD_PROTOCOL}
      adguard_hostname: ${ADGUARD_HOSTNAME:-adguard-home}
      adguard_port: ${ADGUARD_PORT:-3000}
      adguard_username: ${ADGUARD_USER}
      adguard_password: ${ADGUARD_PASS}
      server_port: ${ADGUARD_EXPORTER_PORT}
      interval: ${ADGUARD_SCRAPE_INTERVAL}
      log_limit: 10000
    expose:
      - "${ADGUARD_EXPORTER_PORT}"
    networks: *net_proxy_mon
    restart: *restart_policy
    labels:
      <<: *labels_stack
      com.component: exporter


networks:
  # proxy: reverse proxy / ingress
  proxy:
    external: true
  # mon-net: monitoring / Prometheus scrape
  mon-net:
    external: true
