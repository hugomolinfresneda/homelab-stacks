global:
  scrape_interval: 15s
  evaluation_interval: 15s
alerting:
  alertmanagers:
    - static_configs:
        - targets: ['alertmanager:9093']
rule_files:
  - /etc/prometheus/rules/*.yml
scrape_configs:
  # Self-scrape
  - job_name: 'prometheus'
    static_configs:
      - targets: ['prometheus:9090']
  # Alertmanager metrics
  - job_name: 'alertmanager'
    static_configs:
      - targets: ['alertmanager:9093']
  # Blackbox exporter itself (its own /metrics)
  - job_name: 'blackbox'
    static_configs:
      - targets: ['blackbox:9115']
  # Probes HTTP/HTTPS via Blackbox
  - job_name: 'blackbox-http'
    metrics_path: /probe
    params:
      module: [http_2xx]
    static_configs:
      - targets:
          - https://cloud.atardecer-naranja.es/status.php
          - https://couchdb.atardecer-naranja.es/_up
          - https://dozzle.atardecer-naranja.es/
          - https://uptime-kuma.atardecer-naranja.es/
    relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: blackbox:9115
  # Probes ICMP via Blackbox (ping)
  - job_name: 'blackbox-icmp'
    metrics_path: /probe
    params:
      module: [icmp]
    static_configs:
      - targets:
          - 1.1.1.1
          - 8.8.8.8
    relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: blackbox:9115
  # Node exporter (host metrics)
  - job_name: 'node'
    static_configs:
      - targets: ['node-exporter:9100']
  # Loki
  - job_name: 'loki'
    static_configs:
      - targets: ['loki:3100']
  # Promtail
  - job_name: 'promtail'
    static_configs:
      - targets: ['promtail:9080']  # promtail /metrics
  # Uptime Kuma
  - job_name: 'uptime-kuma'
    scrape_interval: 30s
    metrics_path: /metrics
    static_configs:
      - targets:
          - 'uptime-kuma:3001'
        labels:
          stack: monitoring
          service: uptime-kuma
          env: home
    basic_auth:
      username: ""
      password_file: /etc/prometheus/secrets/kuma_password
  # cAdvisor
  - job_name: 'cadvisor'
    scrape_interval: 30s
    static_configs:
      - targets: ['cadvisor:8080']
  # Nextcloud - MySQL & redis
  - job_name: 'nextcloud-exporters'
    scrape_interval: 15s
    static_configs:
      - targets:
          - 'nc-mysqld-exporter:9104'
          - 'nc-redis-exporter:9121'
  # AdGuard exporter
  - job_name: 'adguard-exporter'
    scrape_interval: 15s
    static_configs:
      - targets:
          - 'adguard-exporter:9617'
  # AdGuard resolve job
  - job_name: 'blackbox-dns'
    metrics_path: /probe
    params:
      module: [dns_udp]
    static_configs:
      - targets:
          - 'adguard-home:53'
    relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target   # target=DNS server
      - source_labels: [__address__]
        target_label: instance
      - target_label: __address__
        replacement: blackbox:9115
  # Cloudflared
  - job_name: 'cloudflared'
    scrape_interval: 30s
    metrics_path: /metrics
    static_configs:
      - targets:
          - 'cloudflared:8081'
        labels:
          stack: proxy
          service: cloudflared
          env: home
  # CouchDB exporter
  - job_name: 'couchdb'
    scrape_interval: 30s
    metrics_path: /metrics

    static_configs:
      - targets:
          - 'couchdb-exporter:9984'
        labels:
          stack: 'couchdb'
          service: 'couchdb'
          env: 'lab'
