global:
  scrape_interval: 15s
  evaluation_interval: 15s
alerting:
  alertmanagers:
    - static_configs:
        - targets: [${PROM_ALERTMANAGER_TARGETS}]
rule_files:
  - /etc/prometheus/rules/*.yml
scrape_configs:
  # Self-scrape
  - job_name: 'prometheus'
    static_configs:
      - targets: [${PROM_SELF_TARGETS}]
  # Alertmanager metrics
  - job_name: 'alertmanager'
    static_configs:
      - targets: [${PROM_ALERTMANAGER_TARGETS}]
  # Blackbox exporter itself (its own /metrics)
  - job_name: 'blackbox'
    static_configs:
      - targets: [${PROM_BLACKBOX_TARGETS}]
  # Probes HTTP/HTTPS via Blackbox
  - job_name: 'blackbox-http'
    metrics_path: /probe
    params:
      module: [http_2xx]
    static_configs:
      - targets:
          - https://cloud.atardecer-naranja.es/status.php
          - https://couchdb.atardecer-naranja.es/_up
          - https://dozzle.atardecer-naranja.es/
          - https://uptime-kuma.atardecer-naranja.es/
    relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - source_labels: [__param_target]
        target_label: target
      - target_label: __address__
        replacement: blackbox:9115
  # Probes ICMP via Blackbox (ping)
  - job_name: 'blackbox-icmp'
    metrics_path: /probe
    params:
      module: [icmp]
    static_configs:
      - targets:
          - 1.1.1.1
          - 8.8.8.8
    relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - source_labels: [__param_target]
        target_label: target
      - target_label: __address__
        replacement: blackbox:9115
  # Node exporter (host metrics)
  - job_name: 'node'
    static_configs:
      - targets: [${PROM_NODE_EXPORTER_TARGETS}]
    metric_relabel_configs:
      - source_labels: [mountpoint, fstype]
        regex: ${ROOT_MOUNTPOINT};${ROOT_FSTYPE}
        target_label: mountpoint_role
        replacement: root
      - source_labels: [mountpoint, fstype]
        regex: ${BACKUP_MOUNTPOINT};${BACKUP_FSTYPE}
        target_label: mountpoint_role
        replacement: backup
  # Loki
  - job_name: 'loki'
    static_configs:
      - targets: [${PROM_LOKI_TARGETS}]
  # Promtail
  - job_name: 'promtail'
    static_configs:
      - targets: [${PROM_PROMTAIL_TARGETS}]  # promtail /metrics
  # Uptime Kuma
  - job_name: 'uptime-kuma'
    scrape_interval: 30s
    metrics_path: /metrics
    static_configs:
      - targets: [${PROM_UPTIME_KUMA_TARGETS}]
        labels:
          stack: monitoring
          service: uptime-kuma
          env: home
    basic_auth:
      username: ""
      password_file: /etc/prometheus/secrets/kuma_password
  # cAdvisor
  - job_name: 'cadvisor'
    scrape_interval: 30s
    static_configs:
      - targets: [${PROM_CADVISOR_TARGETS}]
  # Nextcloud - MySQL & redis
  - job_name: 'nextcloud-exporters'
    scrape_interval: 15s
    static_configs:
      - targets: [${PROM_NEXTCLOUD_EXPORTER_TARGETS}]
  # AdGuard exporter
  - job_name: 'adguard-exporter'
    scrape_interval: 15s
    static_configs:
      - targets: [${PROM_ADGUARD_EXPORTER_TARGETS}]
  # AdGuard resolve job
  - job_name: 'blackbox-dns'
    metrics_path: /probe
    params:
      module: [dns_udp]
    static_configs:
      - targets: [${PROM_ADGUARD_DNS_TARGETS}]
    relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target   # target=DNS server
      - source_labels: [__address__]
        target_label: instance
      - target_label: __address__
        replacement: blackbox:9115
  # Cloudflared
  - job_name: 'cloudflared'
    scrape_interval: 30s
    metrics_path: /metrics
    static_configs:
      - targets: [${PROM_CLOUDFLARED_TARGETS}]
        labels:
          stack: proxy
          service: cloudflared
          env: home
  # CouchDB exporter
  - job_name: 'couchdb'
    scrape_interval: 30s
    metrics_path: /metrics

    static_configs:
      - targets: [${PROM_COUCHDB_EXPORTER_TARGETS}]
        labels:
          stack: 'couchdb'
          service: 'couchdb'
          env: 'lab'
