# homelab-stacks/stacks/monitoring/compose.yaml
# -------------------------------------------------------------------
# Base monitoring stack: Prometheus, Alertmanager, Loki, Promtail,
# Grafana, Blackbox Exporter, Node Exporter, cAdvisor.
# Portable: no host ports here â€” publish only Grafana via your
# reverse proxy / tunnel. Images pinned by digest. External networks:
# `mon-net` (internal) and `proxy` (reverse proxy).
# Runtime overrides live in homelab-runtime/stacks/monitoring/.
# -------------------------------------------------------------------

x-anchors:
  labels-stack: &labels_stack
    com.repo: homelab-stacks
    com.stack: monitoring
    com.env: lab
    com.logging: "true"
  restart-policy: &restart_policy unless-stopped
  networks:
    mon-only: &net_mon_only
      - mon-net
    mon-proxy: &net_mon_proxy
      - mon-net
      - proxy

services:
  prometheus:
    image: prom/prometheus@sha256:ff7e389acbe064a4823212a500393d40a28a8f362e4b05cbf6742a9a3ef736b2
    command:
      - --config.file=/etc/prometheus/prometheus.yml
      - --storage.tsdb.path=/prometheus
      - --web.enable-lifecycle
    expose:
      - "9090"
    volumes:
      - mon-prom-data:/prometheus
      - /opt/homelab-stacks/stacks/monitoring/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - /opt/homelab-stacks/stacks/monitoring/prometheus/rules/:/etc/prometheus/rules/:ro
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:9090/-/ready"]
      interval: 10s
      timeout: 3s
      retries: 6
    networks: *net_mon_proxy
    restart: *restart_policy
    labels: *labels_stack

  alertmanager:
    image: prom/alertmanager@sha256:27c475db5fb156cab31d5c18a4251ac7ed567746a2483ff264516437a39b15ba
    command:
      - "--config.file=/etc/alertmanager/alertmanager.yml"
      # Public URL used by templates (.ExternalURL) to build Alert/Silence links.
      # Runtime-only: set --web.external-url in runtime (compose.override.yml).
    expose:
      - "9093"
    volumes:
      - /opt/homelab-stacks/stacks/monitoring/alertmanager/alertmanager.yml:/etc/alertmanager/alertmanager.yml:ro
      - /opt/homelab-stacks/stacks/monitoring/alertmanager/templates:/etc/alertmanager/templates:ro
      - mon-alertmanager-data:/alertmanager
      # Runtime-only: secret mounts live in compose.override.yml.
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:9093/-/ready"]
      interval: 15s
      timeout: 3s
      retries: 6
    networks: *net_mon_only
    restart: *restart_policy
    environment:
      TZ: Europe/Madrid
    labels: *labels_stack

  blackbox:
    image: prom/blackbox-exporter@sha256:a50c4c0eda297baa1678cd4dc4712a67fdea713b832d43ce7fcc5f9bea05094d
    expose:
      - "9115"
    cap_add:
      - NET_RAW
    volumes:
      - /opt/homelab-stacks/stacks/monitoring/blackbox/blackbox.yml:/etc/blackbox_exporter/config.yml:ro
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:9115/"]
      interval: 30s
      timeout: 3s
      retries: 6
    networks: *net_mon_only
    restart: *restart_policy
    labels: *labels_stack

  loki:
    image: grafana/loki@sha256:0eaee7bf39cc83aaef46914fb58f287d4f4c4be6ec96b86c2ed55719a75e49c8
    command: ["-config.file=/etc/loki/local-config.yaml"]
    expose:
      - "3100"
    volumes:
      - mon-loki-data:/loki
      - /opt/homelab-stacks/stacks/monitoring/loki/config.yaml:/etc/loki/local-config.yaml:ro
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:3100/ready >/dev/null"]
      interval: 15s
      timeout: 3s
      retries: 6
    networks: *net_mon_only
    restart: *restart_policy
    labels: *labels_stack

  promtail:
    image: grafana/promtail@sha256:086e4e85d2eb383fb04ea83c0f5074da81df56e415062ca888dba426abd8dfa5
    command: ["-config.file=/etc/promtail/config.yml"]
    expose:
      - "9080"
    volumes:
      - /opt/homelab-stacks/stacks/monitoring/promtail/config.yaml:/etc/promtail/config.yml:ro
      - mon-promtail-positions:/positions
      # Runtime-only: docker socket + container log mounts live in compose.override.yml.
    networks: *net_mon_only
    restart: *restart_policy
    labels: *labels_stack

  node-exporter:
    image: prom/node-exporter@sha256:d00a542e409ee618a4edc67da14dd48c5da66726bbd5537ab2af9c1dfc442c8a
    command:
      - '--path.rootfs=/host'
      - '--collector.textfile'
      - '--collector.textfile.directory=/textfile-collector'
    # Runtime-only: host filesystem/textfile collector binds live in compose.override.yml.
    expose:
      - "9100"
    networks: *net_mon_only
    restart: *restart_policy
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:9100/metrics >/dev/null || exit 1"]
      interval: 30s
      timeout: 3s
      retries: 6
      start_period: 10s
    labels: *labels_stack

  cadvisor:
    image: gcr.io/cadvisor/cadvisor@sha256:505e2c61e74e5d5eae522d01e2e971e91b793bc405270315a64da806ba033640
    expose:
      - "8080"
    privileged: true
    # Runtime-only: host binds live in compose.override.yml.
    command:
      - --docker_only
      - --housekeeping_interval=30s
      # Optional noise reduction:
      - --disable_metrics=hugetlb,referenced_memory,resctrl,sched,tcp,udp,advtcp
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:8080/healthz"]
      interval: 30s
      timeout: 5s
      retries: 5
    networks: *net_mon_only
    restart: *restart_policy
    labels: *labels_stack

  grafana:
    image: grafana/grafana@sha256:74144189b38447facf737dfd0f3906e42e0776212bf575dc3334c3609183adf7
    expose:
      - "3000"
    environment:
      GF_SECURITY_ADMIN_USER: ${GRAFANA_ADMIN_USER:-admin}
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_ADMIN_PASSWORD:-admin}
      TZ: ${TZ:-Europe/Madrid}
    volumes:
      - mon-grafana-data:/var/lib/grafana
      - /opt/homelab-stacks/stacks/monitoring/grafana/provisioning.mon/datasources:/etc/grafana/provisioning/datasources:ro
      - /opt/homelab-stacks/stacks/monitoring/grafana/provisioning.mon/dashboards:/etc/grafana/provisioning/dashboards:ro
      - ${STACKS_DIR:-/opt/homelab-stacks}/stacks/monitoring/grafana/dashboards/exported/mon:/etc/grafana/provisioning/dashboards/exported-mon:ro
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:3000/api/health"]
      interval: 10s
      timeout: 3s
      retries: 12
    networks: *net_mon_proxy
    restart: *restart_policy
    labels: *labels_stack

volumes:
  mon-prom-data:
    name: mon-prom-data
  mon-grafana-data:
    name: mon-grafana-data
  mon-loki-data:
    name: mon-loki-data
  mon-promtail-positions:
    name: mon-promtail-positions
  mon-alertmanager-data:
    name: mon-alertmanager-data

networks:
  # mon-net: monitoring / Prometheus scrape
  mon-net:
    external: true
  # proxy: reverse proxy / ingress
  proxy:
    external: true
